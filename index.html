<!-- ... garde tout le haut du fichier identique jusqu'à <script> -->

<script>
let base64Image = "";

document.getElementById("imageInput").addEventListener("change", function () {
  const file = this.files[0];
  const reader = new FileReader();
  reader.onload = function () {
    base64Image = reader.result.split(",")[1];
    document.getElementById("imagePreview").innerHTML = `<img src="${reader.result}" alt="Image sélectionnée">`;
  };
  if (file) reader.readAsDataURL(file);
});

async function sendToMarcGPT() {
  const question = document.getElementById("question").value.trim();
  const responseBox = document.getElementById("response");
  const responseText = document.getElementById("responseText");
  responseBox.style.display = "block";
  responseText.innerHTML = "<i>MarcGPT réfléchit à ta question...</i>";

  if (!question) {
    responseText.innerHTML = "<b>Erreur :</b> Tu dois entrer une question.";
    return;
  }

  // Crée le contenu du message
  let content = [{ type: "text", text: question }];
  if (base64Image) {
    content.push({
      type: "image_url",
      image_url: { url: `data:image/jpeg;base64,${base64Image}` }
    });
  }

  // Crée la requête API
  const payload = {
    model: "gpt-4-vision-preview",
    messages: [{ role: "user", content }],
    max_tokens: 1000
  };

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer 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"
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    // Vérifie si une erreur est retournée
    if (data.error) {
      responseText.innerHTML = `<b>Erreur MarcGPT :</b> ${data.error.message}`;
      return;
    }

    // Affiche la réponse proprement
    const reply = data.choices?.[0]?.message?.content;
    if (reply) {
      responseText.innerHTML = reply
        .replace(/\n/g, "<br>")
        .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
    } else {
      responseText.innerHTML = "<b>MarcGPT :</b> Aucune réponse reçue.";
    }

  } catch (err) {
    console.error("Erreur API :", err);
    responseText.innerHTML = "<b>Erreur :</b> Impossible de contacter MarcGPT. Vérifie ta connexion ou ta clé API.";
  }
}
</script>
